<!DOCTYPE html>
<html>
<body>
    <div x-data="{
        products: [
            {
                id: 1,
                name: 'Laptop',
                price: 999,
                tags: ['electronics', 'computers'],
                reviews: [
                    { rating: 5, comment: 'Great laptop!' },
                    { rating: 4, comment: 'Good value' }
                ]
            },
            {
                id: 2,
                name: 'Phone',
                price: 699,
                tags: ['electronics', 'mobile'],
                reviews: [
                    { rating: 5, comment: 'Love it!' }
                ]
            }
        ],
        user: { name: 'John', isAdmin: true, preferences: { theme: 'dark', lang: 'en' } },
        cart: [],
        searchTerm: '',
        isLoading: false,
        addToCart(product) {
            this.cart.push(product);
        },
        getTotal() {
            return this.cart.reduce((sum, item) => sum + item.price, 0);
        }
    }">
        <!-- Header with user info -->
        <header>
            <h1 x-text="`Welcome, ${user.name}`"></h1>
            <div x-show="user.isAdmin">
                <span x-text="'Admin Panel'"></span>
            </div>
            <p x-text="user.preferences.theme"></p>
        </header>

        <!-- Search -->
        <input type="text" x-model="searchTerm" placeholder="Search products...">
        <p x-show="searchTerm.length > 0" x-text="`Searching for: ${searchTerm}`"></p>

        <!-- Loading state -->
        <div x-show="isLoading">
            <span x-text="'Loading...'"></span>
        </div>

        <!-- Product list with nested loops -->
        <div class="products">
            <template x-for="(product, productIndex) in products">
                <div class="product-card">
                    <h2 x-text="product.name"></h2>
                    <p x-text="`$${product.price}`"></p>
                    <p x-text="`Product #${productIndex + 1}`"></p>

                    <!-- Conditional display -->
                    <div x-show="product.price > 500">
                        <span x-text="'Premium Product'"></span>
                    </div>

                    <!-- Tags loop -->
                    <div class="tags">
                        <template x-for="tag in product.tags">
                            <span x-text="tag" class="tag"></span>
                        </template>
                    </div>

                    <!-- Reviews with nested index -->
                    <div class="reviews">
                        <h4 x-text="`Reviews (${product.reviews.length})`"></h4>
                        <template x-for="(review, reviewIndex) in product.reviews">
                            <div class="review">
                                <p x-text="`Review ${reviewIndex + 1}: ${review.comment}`"></p>
                                <span x-text="'â˜…'.repeat(review.rating)"></span>
                                <small x-text="`by ${user.name} on product ${product.name}`"></small>
                            </div>
                        </template>
                    </div>

                    <!-- Actions -->
                    <button @click="addToCart(product)" x-text="'Add to Cart'"></button>
                    <button @click="product.price = product.price * 0.9"
                            x-show="user.isAdmin"
                            x-text="'Apply Discount'"></button>
                </div>
            </template>
        </div>

        <!-- Cart summary -->
        <div class="cart" x-show="cart.length > 0">
            <h3 x-text="`Cart (${cart.length} items)`"></h3>
            <template x-for="(cartItem, cartIndex) in cart">
                <div>
                    <span x-text="cartItem.name"></span>
                    <span x-text="`$${cartItem.price}`"></span>
                    <button @click="cart.splice(cartIndex, 1)" x-text="'Remove'"></button>
                </div>
            </template>
            <div class="total">
                <strong x-text="`Total: $${getTotal()}`"></strong>
            </div>
        </div>

        <!-- Complex expressions -->
        <div class="stats">
            <p x-text="products.filter(p => p.price > 500).length + ' premium products'"></p>
            <p x-text="products.flatMap(p => p.reviews).length + ' total reviews'"></p>
            <p x-text="cart.length > 0 ?
                       `Ready to checkout ${cart.length} items` :
                       'Your cart is empty'"></p>
        </div>

        <!-- Event handlers with complex expressions -->
        <div class="actions">
            <button @click="cart = []"
                    x-show="cart.length > 0"
                    x-text="'Clear Cart'"></button>
            <button @click="isLoading = !isLoading"
                    x-text="isLoading ? 'Stop Loading' : 'Start Loading'"></button>
            <button @click="user.preferences.theme = user.preferences.theme === 'dark' ? 'light' : 'dark'"
                    x-text="`Switch to ${user.preferences.theme === 'dark' ? 'light' : 'dark'} theme`"></button>
        </div>
    </div>
</body>
</html>